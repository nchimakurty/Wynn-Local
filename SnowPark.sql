CREATE OR REPLACE TABLE CONFIG_TABLE (
    CONFIG_KEY STRING,
    CONFIG_VALUE STRING
);


INSERT INTO CONFIG_TABLE (CONFIG_KEY, CONFIG_VALUE) VALUES
('SITE_CODE', 'WLV'),
('RESERVATION_STATUS', 'CHECKED IN'),
('RATECODE_LIST', '%STANBKF%,%STABKFRF%,%SPFBKF%,%SWAVBKF%,%PREFBKF%,%PRFBKFMX%,%PRFBKFVL%,%OTAPBKF%,%OTABBKF%'),
('PHONE_NUMBER_SKIP', '');


WITH RATECODE_VALUES AS (
    SELECT TRIM(VALUE) AS RATECODE
    FROM TABLE(SPLIT_TO_TABLE(
        (SELECT CONFIG_VALUE FROM CONFIG_TABLE WHERE CONFIG_KEY = 'RATECODE_LIST'),
        ','
    ))
),
CONFIGS AS (
    SELECT
        MAX(CASE WHEN CONFIG_KEY = 'SITE_CODE' THEN CONFIG_VALUE END) AS SITE_CODE,
        MAX(CASE WHEN CONFIG_KEY = 'RESERVATION_STATUS' THEN CONFIG_VALUE END) AS RESERVATION_STATUS,
        MAX(CASE WHEN CONFIG_KEY = 'PHONE_NUMBER_SKIP' THEN CONFIG_VALUE END) AS PHONE_NUMBER_SKIP
    FROM CONFIG_TABLE
)
SELECT *
FROM SHR
JOIN RHGP ON SHR.PLAYERID = RHGP.PLAYERID
JOIN CONFIGS
JOIN RATECODE_VALUES
WHERE SHR.SITECODE = CONFIGS.SITE_CODE
  AND SHR.RESERVATIONSTATUS = CONFIGS.RESERVATION_STATUS
  AND SHR.RATECODE ILIKE RATECODE_VALUES.RATECODE
  AND SHR.RESERVATIONDATE <> SHR.CHECKINDATE
  AND SHR.RESERVATIONDATE = CURRENT_DATE
  AND COALESCE(RHGP.PHONENUMBER, '') = CONFIGS.PHONE_NUMBER_SKIP
ORDER BY GRIDNUM, PLAYERID, CONFIRMATIONNUMBER;
